# -*- coding: utf-8 -*-
"""Llama 3 - Hugging Face.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1YF9h7Yvktg4Yxp6nHM2dLtUP4LdBLDZz

Installing the dependencies
"""

pip install -r requirements.txt

import json
import torch
from transformers import (AutoTokenizer,
                          AutoModelForCausalLM,
                          BitsAndBytesConfig,
                          pipeline)

"""**HF account Configuration**"""

config_data = json.load(open("config.json"))
HF_TOKEN = config_data["HF_TOKEN"]

model_name = "meta-llama/Meta-Llama-3-8B"

"""**Quantisation Configuratiion**"""

bnb_config = BitsAndBytesConfig(
    load_in_4bit=True,
    bnb_4bit_use_double_quant=True, # preserve the performance after losing the precision and helps not to lose lot of informations.
    bnb_4bit_quant_type="nf4",
    bnb_4bit_compute_dtype=torch.bfloat16
)

"""**Loading the Tokenizer and the LLM**"""

tokenizer = AutoTokenizer.from_pretrained(model_name,
                                          token=HF_TOKEN)
tokenizer.pad_token = tokenizer.eos_token

model = AutoModelForCausalLM.from_pretrained(
    model_name,
    device_map={"": "cuda"},
    quantization_config=bnb_config,
    token=HF_TOKEN
)

text_generator = pipeline(
    "text-generation",
    model=model,
    tokenizer=tokenizer,
    max_new_tokens=128
)

def get_response(prompt):
  sequences = text_generator(prompt)
  gen_text = sequences[0]["generated_text"]
  return gen_text

prompt = "what is machine learning"

llama3_response = get_response(prompt)

llama3_response

print(llama3_response[len(prompt):])

